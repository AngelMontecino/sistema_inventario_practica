{% extends 'base.html' %}
{% load humanize %}
{% load custom_math %}
{% block title %}Cerrar Caja{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <fluent-card class="p-4">
            <div class="border-bottom pb-3 mb-4">
                <h4 class="mb-0 fw-bold text-danger"><i class='bx bxs-lock-alt me-2'></i>Cierre de Caja</h4>
            </div>
            
            {% if error %}
                <div class="alert alert-danger mb-4">{{ error }}</div>
            {% endif %}

            <div class="row mb-4">
                <div class="col-md-6">
                    <fluent-card class="p-3 bg-light h-100 border-0 shadow-none">
                        <h6 class="text-muted small fw-bold text-uppercase">Saldo Teórico Esperado</h6>
                        <h2 class="text-primary fw-bold my-2">${{ resumen.saldo_teorico|default:"0.00" }}</h2>
                        <small class="text-muted"><i class='bx bx-calculator'></i> Calculado: base + ventas - gastos</small>
                    </fluent-card>
                </div>
                <div class="col-md-6">
                     <ul class="list-group list-group-flush small">
                        <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent ps-0">
                            <span class="text-muted">Saldo Inicial</span>
                            <span class="fw-bold">${{ resumen.saldo_inicial }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent ps-0">
                            <span class="text-muted">Ventas</span>
                            <span class="text-success fw-bold">+${{ resumen.ingresos_ventas }}</span>
                        </li>
                         <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent ps-0">
                            <span class="text-muted">Compras</span>
                            <span class="text-danger fw-bold">-${{ resumen.egresos_compras }}</span>
                        </li>
                    </ul>
                </div>
            </div>

            <form method="post">
                {% csrf_token %}
                <div class="mb-4">
                    <label for="monto_real" class="form-label fw-bold text-secondary">Monto Real en Caja (Contado)</label>
                    <div class="input-group input-group-lg">
                        <span class="input-group-text bg-white border-end-0 fw-bold">$</span>
                        <input type="number" step="0.01" class="form-control border-start-0 ps-0" id="monto_real" name="monto_real" placeholder="0.00" required>
                    </div>
                    <div class="form-text text-danger mt-2"><i class='bx bx-error-circle'></i> Cuente el dinero físico cuidadosamente. Diferencias se registrarán automáticamente.</div>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <fluent-button appearance="outline" onclick="window.location.href='{% url 'gestion_caja' %}'">Cancelar</fluent-button>
                    <fluent-button appearance="accent" type="submit" style="--accent-fill-rest: #dc3545;">
                        <i class='bx bx-lock-alt me-2'></i> Confirmar Cierre
                    </fluent-button>
                </div>
            </form>

            <!-- Detalle de Movimientos (Documentos y Extras) -->
            <div class="mt-5">
                <h5 class="fw-bold mb-3 border-bottom pb-2">Detalle de Operaciones</h5>
                
                <!-- Pestañas -->
                <ul class="nav nav-tabs mb-3" id="cierreTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="docs-tab" data-bs-toggle="tab" data-bs-target="#docs" type="button">Documentos</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="extras-tab" data-bs-toggle="tab" data-bs-target="#extras" type="button">Movimientos Extra</button>
                    </li>
                </ul>

                <div class="tab-content" id="cierreTabContent">
                    <!-- Documentos -->
                    <div class="tab-pane fade show active" id="docs" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover small">
                                <thead class="table-light">
                                    <tr>
                                        <th>Folio</th>
                                        <th>Tipo</th>
                                        <th>Hora</th>
                                        <th>Tercero</th>
                                        <th>Total</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for doc in resumen.documentos %}
                                    <tr>
                                        <td>{{ doc.folio|default:"-" }}</td>
                                        <td>
                                            {% if doc.tipo_operacion == "VENTA" %}<span class="badge bg-info text-dark">VENTA</span>
                                            {% else %}<span class="badge bg-warning text-dark">COMPRA</span>{% endif %}
                                        </td>
                                        <td>{{ doc.fecha_emision|date:"H:i" }}</td>
                                        <td>{{ doc.tercero.nombre|default:"Anónimo" }}</td>
                                        <td class="text-end fw-bold">${{ doc.total|floatformat:0|intcomma }}</td>
                                        <td class="text-end">
                                            <button class="btn btn-sm btn-outline-primary py-0" onclick="loadDocDetails('{{ doc.folio }}', 'content-{{ doc.id_documento }}')">
                                                <i class='bx bx-show'></i>
                                            </button>
                                            <!-- Hidden Content for Modal -->
                                            <div id="content-{{ doc.id_documento }}" class="d-none">
                                                <div class="mb-3">
                                                    <strong>Fecha:</strong> {{ doc.fecha_emision|date:"d/m/Y H:i" }} <br>
                                                    <strong>Vendedor:</strong> {{ doc.usuario.nombre|default:"-" }} <br>
                                                    <strong>Tercero:</strong> {{ doc.tercero.nombre|default:"Anónimo" }}
                                                </div>
                                                <table class="table table-sm table-bordered" style="font-size: 0.9rem;">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>Producto</th>
                                                            <th class="text-center">Cant.</th>
                                                            <th class="text-end">P. Unit</th>
                                                            <th class="text-end">Desc.</th>
                                                            <th class="text-end">Total</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for det in doc.detalles %}
                                                        <tr>
                                                            <td>{{ det.producto.nombre|default:det.id_producto }}</td>
                                                            <td class="text-center">{{ det.cantidad|floatformat:0 }}</td>
                                                            <td class="text-end">${{ det.precio_unitario|floatformat:0|intcomma }}</td>
                                                            <td class="text-end">
                                                                {% if det.descuento > 0 %}{{ det.descuento|floatformat:0 }}%{% else %}-{% endif %}
                                                            </td>
                                                            <td class="text-end fw-bold">
                                                                {% with subtotal=det.cantidad|multiply:det.precio_unitario %}
                                                                    {% if det.descuento > 0 %}
                                                                        ${{ subtotal|calculate_discounted_total:det.descuento|floatformat:0|intcomma }}
                                                                    {% else %}
                                                                        ${{ subtotal|floatformat:0|intcomma }}
                                                                    {% endif %}
                                                                {% endwith %}
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                                <div class="text-end fw-bold fs-5 border-top pt-2">
                                                    Total: ${{ doc.total|floatformat:0|intcomma }}
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="6" class="text-center text-muted">No hay documentos en este período.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Movimientos Extra -->
                    <div class="tab-pane fade" id="extras" role="tabpanel">
                         <div class="table-responsive">
                            <table class="table table-sm table-hover small">
                                <thead class="table-light">
                                    <tr>
                                        <th>Hora</th>
                                        <th>Tipo</th>
                                        <th>Monto</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for mov in resumen.movimientos_extra %}
                                    <tr>
                                        <td>{{ mov.fecha|date:"H:i" }}</td>
                                        <td>
                                            {% if mov.tipo == "INGRESO" %}<span class="badge bg-success">INGRESO</span>
                                            {% else %}<span class="badge bg-danger">EGRESO</span>{% endif %}
                                        </td>
                                        <td class="text-end fw-bold">${{ mov.monto|floatformat:0|intcomma }}</td>
                                        <td class="text-end">
                                            <button class="btn btn-sm btn-outline-secondary py-0" onclick="loadExtraDetails('{{ mov.descripcion }}', '{{ mov.usuario.nombre }}')">
                                                <i class='bx bx-info-circle'></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="4" class="text-center text-muted">No hay movimientos extra.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>



        </fluent-card>
    </div>
</div>


{% endblock %}

{% block scripts %}
<!-- Modal Detalle -->
<div class="modal fade" id="detalleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detalleModalLabel">Detalle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modalBodyContent">
        <!-- Content -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
    function loadDocDetails(folio, contentId) {
        document.getElementById('detalleModalLabel').textContent = 'Detalle Documento: ' + (folio || 'S/N');
        var content = document.getElementById(contentId).innerHTML;
        document.getElementById('modalBodyContent').innerHTML = content;
        
        var modalEl = document.getElementById('detalleModal');
        var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
    }
    
    function loadExtraDetails(descripcion, usuario) {
        document.getElementById('detalleModalLabel').textContent = 'Detalle Movimiento Extra';
        var content = `
            <div class="p-3">
                <h6 class="fw-bold">Descripción:</h6>
                <p class="mb-3">${descripcion || 'Sin descripción'}</p>
                <h6 class="fw-bold">Registrado por:</h6>
                <p class="mb-0">${usuario || '-'}</p>
            </div>
        `;
        document.getElementById('modalBodyContent').innerHTML = content;
        
        var modalEl = document.getElementById('detalleModal');
        var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
    }
</script>
{% endblock %}
