{% extends 'base.html' %}

{% block content %}
<style>
    /* Estilos para el live-search result */
    #searchResults {
        position: absolute;
        z-index: 1000;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        display: none;
    }
    .hover-bg:hover {
        background-color: #f8f9fa;
        cursor: pointer;
    }
    
    /* Fluent Success Modal Styles */
    #successModal .modal-content {
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        border: none;
        text-align: center;
        padding: 30px;
    }
    .success-icon-container {
        width: 80px;
        height: 80px;
        background-color: #d1e7dd;
        color: #0f5132;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px auto;
        font-size: 40px;
        animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes popIn {
        0% { transform: scale(0); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }
    .fluent-title {
        font-weight: 600;
        font-size: 1.5rem;
        color: #212529;
        margin-bottom: 10px;
    }
    .fluent-text {
        color: #6c757d;
        margin-bottom: 25px;
    }

</style>

{% if estado_caja and estado_caja.estado != 'ABIERTA' %}
<div class="container d-flex flex-column justify-content-center align-items-center" style="min-height: 60vh;">
    {% if estado_caja.estado == 'PENDIENTE_CIERRE' %}
        <div class="text-center p-5 bg-white rounded shadow border-start border-5 border-danger">
            <h1 class="text-danger display-1 mb-3"><i class='bx bxs-error'></i></h1>
            <h2 class="fw-bold text-danger mb-3">Cierre Pendiente Oblicatorio</h2>
            <p class="lead mb-4">
                La caja del día <strong>{{ estado_caja.info.fecha|date:"d/m/Y" }}</strong> ({{ estado_caja.info.usuario_nombre }}) sigue abierta.<br>
                Debe cerrar la caja anterior antes de poder emitir nuevos documentos.
            </p>
            <div class="d-grid gap-2 col-8 mx-auto">
                <a href="{% url 'gestion_caja' %}" class="btn btn-danger btn-lg">
                    <i class='bx bx-money'></i> Ir a Cerrar Caja
                </a>
            </div>
        </div>
    {% else %}
        <div class="text-center p-5 bg-white rounded shadow border-start border-5 border-warning">
            <h1 class="text-warning display-1 mb-3"><i class='bx bxs-lock-alt'></i></h1>
            <h2 class="fw-bold text-secondary mb-3">Caja Cerrada</h2>
            <p class="lead mb-4">
                No hay una caja abierta en esta sucursal.<br>
                Debe abrir la caja para comenzar a operar.
            </p>
            <div class="d-grid gap-2 col-8 mx-auto">
                <a href="{% url 'gestion_caja' %}" class="btn btn-primary btn-lg">
                    <i class='bx bx-money'></i> Abrir Caja
                </a>
            </div>
        </div>
    {% endif %}
</div>
<script>
    // Deshabilitar formulario por si acaso 
    document.addEventListener("DOMContentLoaded", function() {
        // Nada que ejecutar porque el contenido principal está oculto
    });
</script>
{% else %}
<!-- CONTENIDO PRINCIPAL SOLO SI ESTA ABIERTA -->

<div class="row mb-4 align-items-center">
    <div class="col-auto me-auto">
        <h2>Crear Documento</h2>
    </div>
    <div class="col-auto">
        <fluent-button appearance="accent" style="--accent-fill-rest: #dc3545;" onclick="window.location.href='{% url 'gestion_caja' %}'">
            <i class='bx bx-money'></i> Gestión de Caja
        </fluent-button>
    </div>
</div>

<fluent-card class="mb-4 p-4">
    <h5 class="mb-3 fw-bold text-primary border-bottom pb-2">Cabecera del Documento</h5>
    <form id="headerForm" class="row g-3">
        <div class="col-md-3">
            <label for="tipoOperacion" class="form-label small fw-bold">Operación</label>
            <select class="form-select" id="tipoOperacion">
                <option value="VENTA" selected>Venta</option>
                {% if request.session.rol != 'VENDEDOR' %}
                <option value="COMPRA">Compra</option>
                {% endif %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="tipoDocumento" class="form-label small fw-bold">Tipo Doc.</label>
            <select class="form-select" id="tipoDocumento">
                <option value="BOLETA">Boleta</option>
                <option value="FACTURA">Factura</option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="searchTercero" class="form-label small fw-bold">Cliente / Proveedor</label>
            <div class="position-relative">
                <input type="hidden" id="tercero">
                <div class="input-group">
                    <span class="input-group-text bg-light"><i class='bx bx-search'></i></span>
                    <input type="text" class="form-control" id="searchTercero" placeholder="Buscar por Nombre o RUT..." autocomplete="off">
                    <button class="btn btn-outline-secondary" type="button" id="btnClearTercero" title="Limpiar" style="display: none;">
                        <i class='bx bx-x'></i>
                    </button>
                </div>
                <ul class="list-group shadow position-absolute w-100" id="terceroResults" style="top: 100%; z-index: 1050; display: none; max-height: 200px; overflow-y: auto;"></ul>
            </div>
        </div>
        <div class="col-md-2">
            <label class="form-label small fw-bold">Fecha</label>
            <input type="text" class="form-control" value="{% now 'd/m/Y' %}" disabled>
        </div>
        <div class="col-md-2">
            <label for="folio" class="form-label small fw-bold">Folio</label>
            <input type="text" class="form-control" id="folio" placeholder="Auto">
        </div>
        <div class="col-md-12">
             <label for="observaciones" class="form-label small fw-bold">Observaciones</label>
             <textarea class="form-control" id="observaciones" rows="2"></textarea>
        </div>
    </form>
</fluent-card>

<fluent-card class="mb-4 p-4">
    <h5 class="mb-3 fw-bold text-secondary border-bottom pb-2">Detalle de Productos</h5>
    
        <!-- Input Linea -->
        <div class="row g-2 align-items-end mb-3">
            <div class="col-md-3 position-relative">
                <label class="form-label small text-muted">Buscar Producto (Nombre/Código)</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="searchProduct" placeholder="Escriba para buscar..." autocomplete="off">
                    <button class="btn btn-outline-secondary" type="button" id="btnClearSelection" title="Limpiar selección">
                        <i class='bx bx-x'></i>
                    </button>
                </div>
                <ul class="list-group shadow" id="searchResults" style="top: 100%;"></ul>
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted">Precio Unit.</label>
                <input type="number" class="form-control" id="linePrice" min="0">
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted">Cantidad</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="lineQty" value="1" min="1">
                    <span class="input-group-text small" id="stockDisplay" title="Stock Disponible">?</span>
                </div>
            </div>
            <div class="col-md-2" id="divUbicacion">
                <label class="form-label small text-muted">Ubicación</label>
                <select class="form-select" id="lineUbicacion"></select>
            </div>
            <div class="col-md-1">
                <label class="form-label small text-muted">Desc %</label>
                <input type="number" class="form-control" id="lineDesc" value="0" min="0" max="100">
            </div>
            <div class="col-md-2">
                 <label class="form-label small text-muted">Subtotal</label>
                 <input type="text" class="form-control bg-light" id="lineSubtotal" disabled>
            </div>
            <div class="col-md-1 d-grid">
                <button class="btn btn-primary" id="btnAddLine"><i class='bx bx-plus'></i></button>
            </div>
        </div>

        <!-- Tabla -->
        <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Producto</th>
                        <th>Ubicación</th>
                        <th class="text-end">Precio</th>
                        <th class="text-center">Cant.</th>
                        <th class="text-center">Desc %</th>
                        <th class="text-end">Subtotal</th>
                        <th class="text-center" style="width: 50px;"></th>
                    </tr>
                </thead>
                <tbody id="detailTableBody">
                    <!-- Dynamic Rows -->
                </tbody>
                <tfoot class="table-light fw-bold">
                <tbody id="detailTableBody">
                    <!-- Dynamic Rows -->
                </tbody>
                <tfoot class="table-light fw-bold">
                    <tr id="rowNeto">
                        <td colspan="3" class="text-end">Total Neto:</td>
                        <td class="text-end" id="totalNeto">$0</td>
                        <td></td>
                    </tr>
                    <tr id="rowIva">
                        <td colspan="3" class="text-end">IVA (19%):</td>
                        <td class="text-end" id="totalIva">$0</td>
                        <td></td>
                    </tr>
                    <tr class="fs-5">
                        <td colspan="3" class="text-end">TOTAL:</td>
                        <td class="text-end text-primary" id="totalGeneral">$0</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <div class="text-end pt-4 border-top d-flex justify-content-between align-items-center">
             <div class="d-flex align-items-center">
                <button type="button" class="btn btn-outline-danger" id="btnDropDraft" title="Eliminar borrador y limpiar formulario">
                    <i class='bx bx-trash me-2'></i> Eliminar Documento
                </button>
                <span id="draftStatus" class="ms-3 text-muted small fst-italic"></span>
             </div>
             <fluent-button appearance="accent" class="px-5" id="btnSaveDocument" style="min-width: 200px;">
                <i class='bx bx-save me-2'></i> Guardar Documento
             </fluent-button>
        </div>
</fluent-card>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="success-icon-container">
        <i class='bx bx-check'></i>
      </div>
      <h3 class="fluent-title">¡Documento Creado!</h3>
      <p class="fluent-text">La operación se ha registrado exitosamente.</p>
      
      <div class="d-grid gap-2">
        <button type="button" class="btn btn-primary btn-lg" id="btnRedirect">
            Aceptar
        </button>
      </div>
    </div>
  </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
  
        let detalles = []; 
        let currentProduct = null;
        let currentBasePrice = 0; 
        const sucursalId = "{{ sucursal_id }}";

        // autoguardado
        function debounce(func, wait) {
            let timeout;
            const executedFunction = function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
            executedFunction.cancel = function() {
                clearTimeout(timeout);
            };
            return executedFunction;
        }

        
        
        function showStatus(msg) {
            const el = document.getElementById("draftStatus");
            if(el) {
                el.innerHTML = `<i class='bx bx-check-circle'></i> ${msg}`;
               
                el.style.opacity = 1;
                setTimeout(() => {
                    el.style.opacity = 0.5; 
                }, 2000);
            }
        }

        function saveDraftData(silent = true) {
            
             if (detalles.length === 0 && !document.getElementById("tercero").value) {
                
                 fetch("{% url 'api_borrador' %}", { method: "DELETE", headers: {"X-CSRFToken": "{{ csrf_token }}"} })
                 .then(res => res.json())
                 .then(data => {
                     if(!silent && data.mensaje) showStatus("Borrador eliminado (vacío)");
                 })
                 .catch(err => console.error(err));
                 return;
             }

            const draftData = {
                tipo_operacion: document.getElementById("tipoOperacion").value,
                tipo_documento: document.getElementById("tipoDocumento").value,
                tercero: {
                    id: document.getElementById("tercero").value,
                    nombre: document.getElementById("searchTercero").value
                },
                observaciones: document.getElementById("observaciones").value,
                detalles: detalles
            };

            fetch("{% url 'api_borrador' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify(draftData)
            })
            .then(res => res.json())
            .then(data => {
                if (data.mensaje) {
                    if(!silent) alert(data.mensaje);
                    else showStatus("Borrador guardado");
                }
            })
            .catch(err => console.error("Auto-save error:", err));
        }

        const autoSaveDraft = debounce(() => saveDraftData(true), 2000);


        // Elements
        const searchInput = document.getElementById("searchProduct");
        const resultsList = document.getElementById("searchResults");
        const priceInput = document.getElementById("linePrice");
        const qtyInput = document.getElementById("lineQty");
        const descInput = document.getElementById("lineDesc");
        const subtotalInput = document.getElementById("lineSubtotal");
        const stockDisplay = document.getElementById("stockDisplay");
        const tableBody = document.getElementById("detailTableBody");
        const btnAdd = document.getElementById("btnAddLine");
        const btnClear = document.getElementById("btnClearSelection");

        // --- Limpiar Selección ---
        btnClear.addEventListener("click", function() {
            currentProduct = null;
            searchInput.value = "";
            priceInput.value = "";
            qtyInput.value = 1;
            descInput.value = 0;
            subtotalInput.value = "";
            stockDisplay.textContent = "?";
            stockDisplay.classList.remove("text-danger");
            document.getElementById("lineUbicacion").innerHTML = "";
            document.getElementById("divUbicacion").style.display = "block";   
             document.getElementById("lineUbicacion").innerHTML = ""; 
            
            searchInput.focus();
        });

        // --- Búsqueda de Productos ---
        let debounceTimer;
        searchInput.addEventListener("input", function() {
            clearTimeout(debounceTimer);
            const query = this.value;
            if (query.length < 2) {
                resultsList.style.display = 'none';
                return;
            }

            debounceTimer = setTimeout(() => {
                fetch(`{% url 'api_buscar_productos' %}?q=${query}`)
                    .then(res => res.json())
                    .then(data => {
                        resultsList.innerHTML = "";
                        if (data && data.length > 0) {
                            resultsList.style.display = 'block';
                            data.forEach(prod => {
                                const li = document.createElement("li");
                                li.className = "list-group-item hover-bg border-bottom";
                                li.innerHTML = `<strong>${prod.nombre}</strong> <small class='text-muted'>$${prod.precio_venta}</small>`;
                                li.onclick = () => selectProduct(prod);
                                resultsList.appendChild(li);
                            });
                        } else {
                            resultsList.style.display = 'none';
                        }
                    });
            }, 300);
        });

      
        // Búsqueda de Terceros (Clientes/Proveedores) 
        const searchTerceroInput = document.getElementById("searchTercero");
        const terceroResults = document.getElementById("terceroResults");
        const terceroHidden = document.getElementById("tercero");
        const btnClearTercero = document.getElementById("btnClearTercero");
        let debounceTercero;

        searchTerceroInput.addEventListener("input", function() {
            clearTimeout(debounceTercero);
            const query = this.value;
            
            // Si borra todo, limpiar 
            if (query.length === 0) {
                terceroHidden.value = "";
                btnClearTercero.style.display = 'none';
            } else {
                btnClearTercero.style.display = 'block';
            }

            if (query.length < 2) {
                terceroResults.style.display = 'none';
                return;
            }

            debounceTercero = setTimeout(() => {
                fetch(`{% url 'api_buscar_terceros' %}?q=${query}`)
                    .then(res => res.json())
                    .then(data => {
                        terceroResults.innerHTML = "";
                        if (data.length > 0) {
                            terceroResults.style.display = 'block';
                            data.forEach(t => {
                                const li = document.createElement("li");
                                li.className = "list-group-item hover-bg border-bottom";
                                // Iconos segun rol
                                let badge = "";
                                if(t.es_cliente) badge += `<span class='badge bg-info me-1'>C</span>`;
                                if(t.es_proveedor) badge += `<span class='badge bg-warning text-dark'>P</span>`;
                                
                                li.innerHTML = `<div><strong>${t.nombre}</strong> <small class='text-muted'>(${t.rut})</small></div><div class='small'>${badge}</div>`;
                                li.onclick = () => selectTercero(t);
                                terceroResults.appendChild(li);
                            });
                        } else {
                            terceroResults.style.display = 'none';
                        }
                    });
            }, 300);
        });

        function selectTercero(t) {
            terceroHidden.value = t.id_tercero;
            searchTerceroInput.value = `${t.nombre} (${t.rut})`;
            terceroResults.style.display = 'none';
            btnClearTercero.style.display = 'block';
            autoSaveDraft();
        }

        btnClearTercero.addEventListener("click", function() {
            terceroHidden.value = "";
            searchTerceroInput.value = "";
            terceroResults.style.display = 'none';
            this.style.display = 'none';
            searchTerceroInput.focus();
            autoSaveDraft(); // Trigger auto-save when clearing third party
        });

        // Cerrar listas al hacer click fuera
        document.addEventListener("click", function(e) {
            if (e.target !== searchInput) {
                resultsList.style.display = 'none';
            }
            if (!searchTerceroInput.contains(e.target) && !terceroResults.contains(e.target)) {
                terceroResults.style.display = 'none';
            }
        });

        function selectProduct(prod) {
            currentProduct = prod;
            searchInput.value = prod.nombre;
            
            const tipoOp = document.getElementById("tipoOperacion").value;
            if (tipoOp === "COMPRA") {
                currentBasePrice = prod.costo_neto;
            } else {
                currentBasePrice = prod.precio_venta;
            }
            priceInput.value = currentBasePrice;

            resultsList.style.display = 'none';
            qtyInput.value = 1;
            descInput.value = 0; // Reset descuento

            // Consultar Stock
            const timestamp = new Date().getTime();
            fetch(`{% url 'api_ver_stock' %}?id_producto=${prod.id_producto}&id_sucursal=${sucursalId}&_=${timestamp}`)
                .catch(err => {
                    console.error("Error fetching stock:", err);
                    stockDisplay.textContent = "Err";
                    stockDisplay.classList.add("text-danger");
                })
                .then(res => res ? res.json() : null)
                .then(data => {
                    if (!data) return;

                    stockDisplay.textContent = data.stock !== undefined ? data.stock : 0;
                    if (data.stock <= 0) {
                         stockDisplay.classList.add("text-danger");
                    } else {
                         stockDisplay.classList.remove("text-danger");
                    }

                    // Manejo de Ubicaciones
                    const divUbicacion = document.getElementById("divUbicacion");
                    const selUbicacion = document.getElementById("lineUbicacion");
                    selUbicacion.innerHTML = "";
                    
                    if (data.detalles) {
                        divUbicacion.style.display = "block";
                        let hasOptions = false;

                        data.detalles.forEach(inv => {
                            if (inv.cantidad > 0) {
                                let opt = document.createElement("option");
                                opt.value = inv.ubicacion_especifica;
                                opt.text = `${inv.ubicacion_especifica} (${inv.cantidad})`;
                                selUbicacion.appendChild(opt);
                                hasOptions = true;
                            }
                        });
                        
                        if (!hasOptions) {
                             let opt = document.createElement("option");
                             opt.text = "Sin Stock";
                             opt.disabled = true;
                             selUbicacion.appendChild(opt);
                        }
                    } else {
                        divUbicacion.style.display = "none";
                    }
                });
            
            updateLineSubtotal();
            qtyInput.focus();
        }

        function updateLineSubtotal() {
            const p = parseFloat(priceInput.value) || 0;
            const q = parseInt(qtyInput.value) || 1;
            const d = parseFloat(descInput.value) || 0;
            const sub = (p * q) * (1 - d/100);
            subtotalInput.value = sub.toLocaleString("es-CL", { style: "currency", currency: "CLP" });
        }

        [priceInput, qtyInput, descInput].forEach(el => el.addEventListener("input", updateLineSubtotal));
        
        // Recalcular al cambiar tipo de documento
        document.getElementById("tipoDocumento").addEventListener("change", renderTable);
        
        // Actualizar precio si cambia el tipo de operación
        document.getElementById("tipoOperacion").addEventListener("change", function() {
            if (currentProduct) {
                if (this.value === "COMPRA") {
                    currentBasePrice = currentProduct.costo_neto;
                } else {
                    currentBasePrice = currentProduct.precio_venta;
                }
               
                priceInput.value = currentBasePrice;
                descInput.value = 0;
                updateLineSubtotal();
            }
        });

   
        priceInput.addEventListener("blur", function() {
            if (!currentProduct || currentBasePrice === 0) return;

            const enteredPrice = parseFloat(this.value);
            if (isNaN(enteredPrice)) return;


            if (enteredPrice !== currentBasePrice) {
               
                
                let descPct = (1 - (enteredPrice / currentBasePrice)) * 100;
                
               
                descPct = Math.round(descPct * 100) / 100;

                descInput.value = descPct;
                
               
                this.value = currentBasePrice;
                
              
                
                updateLineSubtotal();
            }
        });


        // --- Agregar Linea ---
        btnAdd.addEventListener("click", function() {
            if (!currentProduct) {
                alert("Seleccione un producto.");
                return;
            }
            const precio = parseFloat(priceInput.value);
            const cantidad = parseInt(qtyInput.value);
            const descuento = parseFloat(descInput.value) || 0;
            
            if (cantidad <= 0) return alert("Cantidad inválida");

            const ubicacionSeleccionada = (document.getElementById("divUbicacion").style.display !== "none" || document.getElementById("lineUbicacion").offsetParent !== null) 
                                          ? document.getElementById("lineUbicacion").value 
                                          : "";
            
            // Verificar si ya existe el producto en el detalle (sumar cantidad)
            const existeIndex = detalles.findIndex(d => d.id_producto === currentProduct.id_producto && d.ubicacion_especifica === ubicacionSeleccionada);
            
            if (existeIndex >= 0) {
                detalles[existeIndex].cantidad += cantidad;
                detalles[existeIndex].precio = precio; 
                detalles[existeIndex].descuento = descuento;
                detalles[existeIndex].subtotal = (detalles[existeIndex].precio * detalles[existeIndex].cantidad) * (1 - descuento/100);
            } else {
                detalles.push({
                    id_producto: currentProduct.id_producto,
                    nombre: currentProduct.nombre,
                    precio: precio,
                    cantidad: cantidad,
                    descuento: descuento,
                    subtotal: (precio * cantidad) * (1 - descuento/100),
                    ubicacion_especifica: ubicacionSeleccionada
                });
            }

            // Reset inputs
            currentProduct = null;
            searchInput.value = "";
            priceInput.value = "";
            qtyInput.value = 1;
            descInput.value = 0;
            subtotalInput.value = "";
            stockDisplay.textContent = "?";
            document.getElementById("lineUbicacion").innerHTML = ""; // Limpiar selector
            
            renderTable();
        });

        window.removeLine = function(index) {
            detalles.splice(index, 1);
            renderTable();
        }

        function renderTable() {
            tableBody.innerHTML = "";
            let totalGen = 0;
            let totalNeto = 0;
            let totalIva = 0;
            
            detalles.forEach((d, index) => {
                totalGen += d.subtotal;
                
                // Calcular Neto e IVA por línea (asumiendo precio Bruto)
                const netoLinea = Math.round(d.subtotal / 1.19);
                const ivaLinea = d.subtotal - netoLinea;
                
                totalNeto += netoLinea;
                totalIva += ivaLinea;

                const row = `
                    <tr>
                        <td>${d.nombre}</td>
                        <td>${d.ubicacion_especifica || '-'}</td>
                        <td class="text-end">$${d.precio}</td>
                        <td class="text-center">${d.cantidad}</td>
                        <td class="text-center">${d.descuento}%</td>
                        <td class="text-end">$${d.subtotal.toLocaleString("es-CL")}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-danger" onclick="removeLine(${index})">
                                <i class='bx bx-trash'></i>
                            </button>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML("beforeend", row);
            });

    

            const tipoDoc = document.getElementById("tipoDocumento").value;
            const rowNeto = document.getElementById("rowNeto");
            const rowIva = document.getElementById("rowIva");
            
            if (tipoDoc === "FACTURA" || tipoDoc === "BOLETA") {
                // Mostrar desglose
                rowNeto.style.display = "table-row";
                rowIva.style.display = "table-row";
            } else {
                rowNeto.style.display = "none";
                rowIva.style.display = "none";
            }

            document.getElementById("totalGeneral").textContent = "$" + totalGen.toLocaleString("es-CL");
            document.getElementById("totalNeto").textContent = "$" + totalNeto.toLocaleString("es-CL");
            document.getElementById("totalIva").textContent = "$" + totalIva.toLocaleString("es-CL");
            autoSaveDraft();
        }

        // --- Guardar Documento ---
        document.getElementById("btnSaveDocument").addEventListener("click", function() {
           
            if (autoSaveDraft.cancel) autoSaveDraft.cancel();

            if (detalles.length === 0) {
                alert("Debe agregar productos al detalle.");
                return;
            }
            
            const terceroId = document.getElementById("tercero").value;
            const tipoDoc = document.getElementById("tipoDocumento").value;

            // Validación: Factura requiere Tercero
            if (tipoDoc === "FACTURA" && !terceroId) {
                alert("Para emitir una FACTURA debe seleccionar un Cliente o Proveedor.");
                return;
            }
            
            /* Validación si es venta requiere cliente? Depende regla negocio. */
            
            const payload = {
                tipo_operacion: document.getElementById("tipoOperacion").value,
                tipo_documento: document.getElementById("tipoDocumento").value,
                tipo_documento: document.getElementById("tipoDocumento").value,
                folio: document.getElementById("folio").value || null, 
                estado_pago: "PAGADO", // Default POS
                observaciones: document.getElementById("observaciones").value || "",
                id_documento: 0,
                id_sucursal: parseInt(sucursalId) || 0, 
                id_tercero: terceroId ? parseInt(terceroId) : null,
                id_usuario: 0, 
                fecha_emision: new Date().toISOString(),
                detalles: detalles.map(d => ({
                    id_producto: d.id_producto,
                    cantidad: d.cantidad,
                    cantidad: d.cantidad,
                    precio_unitario: d.precio,
                    descuento: d.descuento,
                    ubicacion_especifica: d.ubicacion_especifica
                })),
                total: 0 // Backend calcula
            };

            // Enviar
            fetch("{% url 'crear_documento' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === "success") {
                    fetch("{% url 'api_borrador' %}", { method: "DELETE", headers: {"X-CSRFToken": "{{ csrf_token }}"} });
                    
                    // mostrar Fluent Modal
                    const modalEl = document.getElementById('successModal');
                    const modal = new bootstrap.Modal(modalEl);
                    const btnRedirect = document.getElementById('btnRedirect');
                    
                    btnRedirect.onclick = function() {
                        window.location.href = data.redirect_url;
                    };
                    
                    modal.show();
                    
                    
                    setTimeout(() => {
                         window.location.href = data.redirect_url;
                    }, 2000);

                } else {
                    alert("Error: " + data.message);
                }
            })
            .catch(err => alert("Error de comunicación: " + err));
        });

        // LISTENERS autguardado
        // Inputs de cabecera que deben guardar cambios
        const inputsToWatch = [
            document.getElementById("tipoOperacion"), 
            document.getElementById("tipoDocumento"), 
            document.getElementById("observaciones"),
            
        ];
        inputsToWatch.forEach(el => {
            if(el) {
                el.addEventListener("change", autoSaveDraft);
                el.addEventListener("input", autoSaveDraft);
            }
        });
        
    
        
        
        function loadDraftData(silent = false) {
             fetch("{% url 'api_borrador' %}")
                .then(res => res.json())
                .then(data => {
                    if (!data || Object.keys(data).length === 0) {
                        if (!silent) alert("No hay borrador guardado.");
                        return;
                    }

                    if (!silent && detalles.length > 0) {
                        if(!confirm("Esto sobrescribirá la venta actual. ¿Continuar?")) return;
                    }

                    // Restore
                    if (data.tipo_operacion) {
                        document.getElementById("tipoOperacion").value = data.tipo_operacion;
                      
                        document.getElementById("tipoOperacion").dispatchEvent(new Event('change'));
                    }
                    if (data.tipo_documento) document.getElementById("tipoDocumento").value = data.tipo_documento;
                    if (data.observaciones) document.getElementById("observaciones").value = data.observaciones;
                    
                    if (data.tercero && data.tercero.id) {
                        terceroHidden.value = data.tercero.id;
                        searchTerceroInput.value = data.tercero.nombre;
                        btnClearTercero.style.display = 'block';
                    }

                    if (data.detalles && Array.isArray(data.detalles)) {
                        detalles = data.detalles;
                        
                        renderTable(); 
                    }
                    
                    if (!silent) alert("Borrador cargado.");
                    else {
                        showStatus("Borrador restaurado");
                    }
                })
                .catch(err => console.error(err));
        }

        // limpiar documento
        document.getElementById("btnDropDraft").addEventListener("click", function() {
            if(!confirm("¿Está seguro de eliminar todo el documento y volver a empezar? Esta acción no se puede deshacer.")) return;

            //  Limpiar Variables
            detalles = [];
            currentProduct = null;
            
            //  Limpiar UI 
            document.getElementById("tipoOperacion").value = "VENTA";
            document.getElementById("tipoDocumento").value = "BOLETA";
            document.getElementById("folio").value = "";
            document.getElementById("observaciones").value = "";
            
            terceroHidden.value = "";
            searchTerceroInput.value = "";
            btnClearTercero.style.display = 'none';

            //  Limpiar Inputs Linea
            searchInput.value = "";
            priceInput.value = "";
            qtyInput.value = 1;
            descInput.value = 0;
            subtotalInput.value = "";
            stockDisplay.textContent = "?";
            document.getElementById("lineUbicacion").innerHTML = "";
            
            
            renderTable();

            //  eliminar del Backend
            fetch("{% url 'api_borrador' %}", { method: "DELETE", headers: {"X-CSRFToken": "{{ csrf_token }}"} })
            .then(res => res.json())
            .then(() => {
                const el = document.getElementById("draftStatus");
                if(el) el.innerHTML = ""; // Clear status
            })
            .catch(err => console.error(err));
        });

        // auguardado start
        setTimeout(() => loadDraftData(true), 500); 
    });
</script>
{% endif %}
{% endblock %}
