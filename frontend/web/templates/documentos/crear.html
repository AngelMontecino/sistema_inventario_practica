{% extends 'base.html' %}

{% block content %}
<style>
    /* Estilos para el live-search result */
    #searchResults {
        position: absolute;
        z-index: 1000;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        display: none;
    }
    .hover-bg:hover {
        background-color: #f8f9fa;
        cursor: pointer;
    }
</style>

<div class="row mb-4 align-items-center">
    <div class="col-auto me-auto">
        <h2>Crear Documento</h2>
    </div>
    <div class="col-auto">
        <a href="{% url 'gestion_caja' %}" class="btn btn-outline-danger">
            <i class="bi bi-cash-coin"></i> Gestión de Caja
        </a>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header bg-white py-3">
        <h5 class="mb-0">Cabecera del Documento</h5>
    </div>
    <div class="card-body">
        <form id="headerForm" class="row g-3">
            <div class="col-md-3">
                <label for="tipoOperacion" class="form-label">Operación</label>
                <select class="form-select" id="tipoOperacion">
                    <option value="VENTA" selected>Venta</option>
                    <option value="COMPRA">Compra</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="tipoDocumento" class="form-label">Tipo Doc.</label>
                <select class="form-select" id="tipoDocumento">
                    <option value="BOLETA">Boleta</option>
                    <option value="FACTURA">Factura</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="tercero" class="form-label">Cliente / Proveedor</label>
                <select class="form-select" id="tercero">
                    <option value="">-- Seleccionar --</option>
                    {% for t in terceros %}
                        <option value="{{ t.id_tercero }}" data-cliente="{{ t.es_cliente }}" data-proveedor="{{ t.es_proveedor }}">
                            {{ t.nombre }} ({{ t.rut }})
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Fecha</label>
                <input type="text" class="form-control" value="{% now 'd/m/Y' %}" disabled>
            </div>
            <div class="col-md-2">
                <label for="folio" class="form-label">Folio</label>
                <input type="text" class="form-control" id="folio" placeholder="Auto">
            </div>
            <div class="col-md-12">
                 <label for="observaciones" class="form-label">Observaciones</label>
                 <textarea class="form-control" id="observaciones" rows="2"></textarea>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header bg-white py-3">
        <h5 class="mb-0">Detalle de Productos</h5>
    </div>
    <div class="card-body">
        <!-- Input Linea -->
        <div class="row g-2 align-items-end mb-3">
            <div class="col-md-3 position-relative">
                <label class="form-label small text-muted">Buscar Producto (Nombre/Código)</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="searchProduct" placeholder="Escriba para buscar..." autocomplete="off">
                    <button class="btn btn-outline-secondary" type="button" id="btnClearSelection" title="Limpiar selección">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                <ul class="list-group shadow" id="searchResults" style="top: 100%;"></ul>
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted">Precio Unit.</label>
                <input type="number" class="form-control" id="linePrice" min="0">
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted">Cantidad</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="lineQty" value="1" min="1">
                    <span class="input-group-text small" id="stockDisplay" title="Stock Disponible">?</span>
                </div>
            </div>
            <div class="col-md-2" id="divUbicacion">
                <label class="form-label small text-muted">Ubicación</label>
                <select class="form-select" id="lineUbicacion"></select>
            </div>
            <div class="col-md-1">
                <label class="form-label small text-muted">Desc %</label>
                <input type="number" class="form-control" id="lineDesc" value="0" min="0" max="100">
            </div>
            <div class="col-md-2">
                 <label class="form-label small text-muted">Subtotal</label>
                 <input type="text" class="form-control bg-light" id="lineSubtotal" disabled>
            </div>
            <div class="col-md-1 d-grid">
                <button class="btn btn-primary" id="btnAddLine"><i class="bi bi-plus-lg"></i> Agregar</button>
            </div>
        </div>

        <!-- Tabla -->
        <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Producto</th>
                        <th>Ubicación</th>
                        <th class="text-end">Precio</th>
                        <th class="text-center">Cant.</th>
                        <th class="text-center">Desc %</th>
                        <th class="text-end">Subtotal</th>
                        <th class="text-center" style="width: 50px;"></th>
                    </tr>
                </thead>
                <tbody id="detailTableBody">
                    <!-- Dynamic Rows -->
                </tbody>
                <tfoot class="table-light fw-bold">
                <tbody id="detailTableBody">
                    <!-- Dynamic Rows -->
                </tbody>
                <tfoot class="table-light fw-bold">
                    <tr id="rowNeto">
                        <td colspan="3" class="text-end">Total Neto:</td>
                        <td class="text-end" id="totalNeto">$0</td>
                        <td></td>
                    </tr>
                    <tr id="rowIva">
                        <td colspan="3" class="text-end">IVA (19%):</td>
                        <td class="text-end" id="totalIva">$0</td>
                        <td></td>
                    </tr>
                    <tr class="fs-5">
                        <td colspan="3" class="text-end">TOTAL:</td>
                        <td class="text-end text-primary" id="totalGeneral">$0</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    <div class="card-footer bg-white text-end py-3">
         <button class="btn btn-success btn-lg px-5" id="btnSaveDocument">
            <i class="bi bi-save"></i> Guardar Documento
         </button>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
  
        let detalles = []; 
        let currentProduct = null;
        let currentBasePrice = 0; 
        const sucursalId = "{{ sucursal_id }}";

        // Elements
        const searchInput = document.getElementById("searchProduct");
        const resultsList = document.getElementById("searchResults");
        const priceInput = document.getElementById("linePrice");
        const qtyInput = document.getElementById("lineQty");
        const descInput = document.getElementById("lineDesc");
        const subtotalInput = document.getElementById("lineSubtotal");
        const stockDisplay = document.getElementById("stockDisplay");
        const tableBody = document.getElementById("detailTableBody");
        const btnAdd = document.getElementById("btnAddLine");
        const btnClear = document.getElementById("btnClearSelection");

        // --- Limpiar Selección ---
        btnClear.addEventListener("click", function() {
            currentProduct = null;
            searchInput.value = "";
            priceInput.value = "";
            qtyInput.value = 1;
            descInput.value = 0;
            subtotalInput.value = "";
            stockDisplay.textContent = "?";
            stockDisplay.classList.remove("text-danger");
            document.getElementById("lineUbicacion").innerHTML = "";
            document.getElementById("divUbicacion").style.display = "block"; 
             document.getElementById("lineUbicacion").innerHTML = ""; 
            
            searchInput.focus();
        });

        // --- Búsqueda de Productos ---
        let debounceTimer;
        searchInput.addEventListener("input", function() {
            clearTimeout(debounceTimer);
            const query = this.value;
            if (query.length < 2) {
                resultsList.style.display = 'none';
                return;
            }

            debounceTimer = setTimeout(() => {
                fetch(`{% url 'api_buscar_productos' %}?q=${query}`)
                    .then(res => res.json())
                    .then(data => {
                        resultsList.innerHTML = "";
                        if (data.length > 0) {
                            resultsList.style.display = 'block';
                            data.forEach(prod => {
                                const li = document.createElement("li");
                                li.className = "list-group-item hover-bg border-bottom";
                                li.innerHTML = `<strong>${prod.nombre}</strong> <small class='text-muted'>$${prod.precio_venta}</small>`;
                                li.onclick = () => selectProduct(prod);
                                resultsList.appendChild(li);
                            });
                        } else {
                            resultsList.style.display = 'none';
                        }
                    });
            }, 300);
        });

      
        document.addEventListener("click", function(e) {
            if (e.target !== searchInput) {
                resultsList.style.display = 'none';
            }
        });

        function selectProduct(prod) {
            currentProduct = prod;
            searchInput.value = prod.nombre;
            
            const tipoOp = document.getElementById("tipoOperacion").value;
            if (tipoOp === "COMPRA") {
                currentBasePrice = prod.costo_neto;
            } else {
                currentBasePrice = prod.precio_venta;
            }
            priceInput.value = currentBasePrice;

            resultsList.style.display = 'none';
            qtyInput.value = 1;
            descInput.value = 0; // Reset descuento

            // Consultar Stock
            const timestamp = new Date().getTime();
            fetch(`{% url 'api_ver_stock' %}?id_producto=${prod.id_producto}&id_sucursal=${sucursalId}&_=${timestamp}`)
                .catch(err => {
                    console.error("Error fetching stock:", err);
                    stockDisplay.textContent = "Err";
                    stockDisplay.classList.add("text-danger");
                })
                .then(res => res ? res.json() : null)
                .then(data => {
                    if (!data) return;

                    stockDisplay.textContent = data.stock !== undefined ? data.stock : 0;
                    if (data.stock <= 0) {
                         stockDisplay.classList.add("text-danger");
                    } else {
                         stockDisplay.classList.remove("text-danger");
                    }

                    // Manejo de Ubicaciones
                    const divUbicacion = document.getElementById("divUbicacion");
                    const selUbicacion = document.getElementById("lineUbicacion");
                    selUbicacion.innerHTML = "";
                    
                    if (data.detalles) {
                        divUbicacion.style.display = "block";
                        let hasOptions = false;

                        data.detalles.forEach(inv => {
                            if (inv.cantidad > 0) {
                                let opt = document.createElement("option");
                                opt.value = inv.ubicacion_especifica;
                                opt.text = `${inv.ubicacion_especifica} (${inv.cantidad})`;
                                selUbicacion.appendChild(opt);
                                hasOptions = true;
                            }
                        });
                        
                        if (!hasOptions) {
                             let opt = document.createElement("option");
                             opt.text = "Sin Stock";
                             opt.disabled = true;
                             selUbicacion.appendChild(opt);
                        }
                    } else {
                        divUbicacion.style.display = "none";
                    }
                });
            
            updateLineSubtotal();
            qtyInput.focus();
        }

        function updateLineSubtotal() {
            const p = parseFloat(priceInput.value) || 0;
            const q = parseInt(qtyInput.value) || 1;
            const d = parseFloat(descInput.value) || 0;
            const sub = (p * q) * (1 - d/100);
            subtotalInput.value = sub.toLocaleString("es-CL", { style: "currency", currency: "CLP" });
        }

        [priceInput, qtyInput, descInput].forEach(el => el.addEventListener("input", updateLineSubtotal));
        
        // Recalcular al cambiar tipo de documento
        document.getElementById("tipoDocumento").addEventListener("change", renderTable);
        
        // Actualizar precio si cambia el tipo de operación
        document.getElementById("tipoOperacion").addEventListener("change", function() {
            if (currentProduct) {
                if (this.value === "COMPRA") {
                    currentBasePrice = currentProduct.costo_neto;
                } else {
                    currentBasePrice = currentProduct.precio_venta;
                }
               
                priceInput.value = currentBasePrice;
                descInput.value = 0;
                updateLineSubtotal();
            }
        });

   
        priceInput.addEventListener("blur", function() {
            if (!currentProduct || currentBasePrice === 0) return;

            const enteredPrice = parseFloat(this.value);
            if (isNaN(enteredPrice)) return;


            if (enteredPrice !== currentBasePrice) {
               
                
                let descPct = (1 - (enteredPrice / currentBasePrice)) * 100;
                
               
                descPct = Math.round(descPct * 100) / 100;

                descInput.value = descPct;
                
               
                this.value = currentBasePrice;
                
              
                
                updateLineSubtotal();
            }
        });


        // --- Agregar Linea ---
        btnAdd.addEventListener("click", function() {
            if (!currentProduct) {
                alert("Seleccione un producto.");
                return;
            }
            const precio = parseFloat(priceInput.value);
            const cantidad = parseInt(qtyInput.value);
            const descuento = parseFloat(descInput.value) || 0;
            
            if (cantidad <= 0) return alert("Cantidad inválida");

            const ubicacionSeleccionada = (document.getElementById("divUbicacion").style.display !== "none" || document.getElementById("lineUbicacion").offsetParent !== null) 
                                          ? document.getElementById("lineUbicacion").value 
                                          : "";
            
            // Verificar si ya existe el producto en el detalle (sumar cantidad)
            const existeIndex = detalles.findIndex(d => d.id_producto === currentProduct.id_producto && d.ubicacion_especifica === ubicacionSeleccionada);
            
            if (existeIndex >= 0) {
                detalles[existeIndex].cantidad += cantidad;
                detalles[existeIndex].precio = precio; 
                detalles[existeIndex].descuento = descuento;
                detalles[existeIndex].subtotal = (detalles[existeIndex].precio * detalles[existeIndex].cantidad) * (1 - descuento/100);
            } else {
                detalles.push({
                    id_producto: currentProduct.id_producto,
                    nombre: currentProduct.nombre,
                    precio: precio,
                    cantidad: cantidad,
                    descuento: descuento,
                    subtotal: (precio * cantidad) * (1 - descuento/100),
                    ubicacion_especifica: ubicacionSeleccionada
                });
            }

            // Reset inputs
            currentProduct = null;
            searchInput.value = "";
            priceInput.value = "";
            qtyInput.value = 1;
            descInput.value = 0;
            subtotalInput.value = "";
            stockDisplay.textContent = "?";
            document.getElementById("lineUbicacion").innerHTML = ""; // Limpiar selector
            
            renderTable();
        });

        window.removeLine = function(index) {
            detalles.splice(index, 1);
            renderTable();
        }

        function renderTable() {
            tableBody.innerHTML = "";
            let total = 0;
            
            detalles.forEach((d, index) => {
                total += d.subtotal;
                const row = `
                    <tr>
                        <td>${d.nombre}</td>
                        <td>${d.ubicacion_especifica || '-'}</td>
                        <td class="text-end">$${d.precio}</td>
                        <td class="text-center">${d.cantidad}</td>
                        <td class="text-center">${d.descuento}%</td>
                        <td class="text-end">$${d.subtotal.toLocaleString("es-CL")}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-danger" onclick="removeLine(${index})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML("beforeend", row);
            });

          
            const totalGen = total;
            const iva = Math.round(totalGen * 0.19); // Aproximacion si fuera neto
            const neto = totalGen - iva; // Matematicamente incorrecto si total es Bruto.
            
            // Asumiendo PRECIO FINAL (Bruto):
            const precioNetoReal = Math.round(totalGen / 1.19);
            const ivaReal = totalGen - precioNetoReal;

            const tipoDoc = document.getElementById("tipoDocumento").value;
            const rowNeto = document.getElementById("rowNeto");
            const rowIva = document.getElementById("rowIva");
            
            if (tipoDoc === "FACTURA" || tipoDoc === "BOLETA") {
                // Mostrar desglose
                rowNeto.style.display = "table-row";
                rowIva.style.display = "table-row";
            } else {
                rowNeto.style.display = "none";
                rowIva.style.display = "none";
            }

            document.getElementById("totalGeneral").textContent = "$" + totalGen.toLocaleString("es-CL");
            document.getElementById("totalNeto").textContent = "$" + precioNetoReal.toLocaleString("es-CL");
            document.getElementById("totalIva").textContent = "$" + ivaReal.toLocaleString("es-CL");
        }

        // --- Guardar Documento ---
        document.getElementById("btnSaveDocument").addEventListener("click", function() {
            if (detalles.length === 0) {
                alert("Debe agregar productos al detalle.");
                return;
            }
            
            const terceroId = document.getElementById("tercero").value;
            const tipoDoc = document.getElementById("tipoDocumento").value;

            // Validación: Factura requiere Tercero
            if (tipoDoc === "FACTURA" && !terceroId) {
                alert("Para emitir una FACTURA debe seleccionar un Cliente o Proveedor.");
                return;
            }
            
            /* Validación si es venta requiere cliente? Depende regla negocio. */
            
            const payload = {
                tipo_operacion: document.getElementById("tipoOperacion").value,
                tipo_documento: document.getElementById("tipoDocumento").value,
                tipo_documento: document.getElementById("tipoDocumento").value,
                folio: document.getElementById("folio").value || null, 
                estado_pago: "PAGADO", // Default POS
                observaciones: document.getElementById("observaciones").value || "",
                id_documento: 0,
                id_sucursal: parseInt(sucursalId) || 0, 
                id_tercero: terceroId ? parseInt(terceroId) : null,
                id_usuario: 0, 
                fecha_emision: new Date().toISOString(),
                detalles: detalles.map(d => ({
                    id_producto: d.id_producto,
                    cantidad: d.cantidad,
                    cantidad: d.cantidad,
                    precio_unitario: d.precio,
                    descuento: d.descuento,
                    ubicacion_especifica: d.ubicacion_especifica
                })),
                total: 0 // Backend calcula
            };

            // Enviar
            fetch("{% url 'crear_documento' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === "success") {
                    alert("Documento creado exitosamente!");
                    window.location.href = data.redirect_url;
                } else {
                    alert("Error: " + data.message);
                }
            })
            .catch(err => alert("Error de comunicación: " + err));
        });
    });
</script>
{% endblock %}
