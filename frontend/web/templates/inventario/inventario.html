{% extends 'base.html' %}

{% block title %}Gestión de Inventario - Sistema Inventario{% endblock %}

{% block content %}
<div class="row mb-4 align-items-center">
    <div class="col">
        <h1 class="h3 fw-bold mb-0 text-gray-800">Inventario Global</h1>
        <p class="text-muted small mb-0">Visualiza y gestiona el stock de tus productos por sucursal.</p>
    </div>
</div>

<!-- Filtros y Búsqueda -->
<fluent-card class="mb-4 p-4">
    <form method="GET" class="row g-3 align-items-end" onsubmit="event.preventDefault(); return false;">
        <!-- Filtro Sucursal -->
        <div class="col-md-4">
            <label for="sucursal_id" class="form-label fw-bold text-secondary text-uppercase small">Filtrar por Sucursal</label>
            <div class="input-group">
                <span class="input-group-text bg-light border-end-0"><i class='bx bx-store text-primary'></i></span>
                {% if request.session.rol == 'VENDEDOR' %}
                    <!-- VENDEDOR: Mostrar sucursal fija -->
                    <input type="text" class="form-control border-start-0 ps-0 bg-light text-muted" value="{{ request.session.nombre_sucursal }}" disabled readonly>
                {% else %}
                    <!-- ADMIN: Selector de sucursales -->
                    <select class="form-select border-start-0 ps-0 bg-light" id="sucursal_id" name="sucursal_id" onchange="this.form.submit()">
                        <option value="" {% if not sucursal_seleccionada %}selected{% endif %} disabled>-- Selecciona Sucursal --</option>
                        {% for suc in sucursales %}
                            <option value="{{ suc.id_sucursal }}" {% if sucursal_seleccionada == suc.id_sucursal %}selected{% endif %}>
                                {{ suc.nombre }}
                            </option>
                        {% endfor %}
                    </select>
                {% endif %}
            </div>
        </div>
        <!-- Filtro Categoría -->
        <div class="col-md-3">
            <label for="categoria_id" class="form-label fw-bold text-secondary text-uppercase small">Filtrar por Categoría</label>
            <div class="input-group">
                <span class="input-group-text bg-light border-end-0"><i class='bx bx-category text-primary'></i></span>
                <select class="form-select border-start-0 ps-0 bg-light" id="categoria_id" name="categoria_id" onchange="this.form.submit()">
                    <option value="" {% if not filtro_categoria %}selected{% endif %}>-- Todas --</option>
                    {% for cat in categorias %}
                        <option value="{{ cat.id_categoria }}" {% if filtro_categoria == cat.id_categoria %}selected{% endif %}>
                            {{ cat.nombre }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
         <!-- Buscador -->
         <div class="col-md-6">
            <label for="q" class="form-label fw-bold text-secondary text-uppercase small">Buscar Producto</label>
            <div class="input-group">
                <span class="input-group-text bg-light border-end-0"><i class='bx bx-search text-primary'></i></span>
                <input type="text" class="form-control border-start-0 ps-0 bg-light" id="q" name="q" value="{{ busqueda }}" placeholder="Nombre o código de barras...">
                {% if busqueda %}
                    <fluent-button appearance="outline" onclick="window.location.href='{% url 'lista_inventario' %}{% if sucursal_seleccionada %}?sucursal_id={{ sucursal_seleccionada }}{% endif %}'" title="Limpiar"><i class='bx bx-x'></i></fluent-button>
                {% endif %}
            </div>
        </div>
        <div class="col-md-2 text-end">
             <!-- Espacio para futuro -->
        </div>
    </form>
</fluent-card>

{% if error %}
    <div class="alert alert-danger shadow-sm rounded-3 mb-4 border-0 border-start border-4 border-danger">
        <div class="d-flex align-items-center">
            <i class='bx bx-error-circle fs-4 me-3'></i>
            <div>{{ error }}</div>
        </div>
    </div>
{% endif %}

<!-- Tabla de Inventario -->
<fluent-card class="p-0 overflow-hidden">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light text-secondary text-uppercase small fw-bold">
                <tr>
                    <th class="px-4 py-3">ID Producto</th>
                    <th class="py-3">Producto</th>
                    <th class="py-3">Código Barras</th>
                    <th class="py-3 text-center">Stock Total</th>
                    <th class="py-3 text-center">Acciones</th>
                </tr>
            </thead>
            <tbody id="inventarioBody">
                {% for item in inventario %}
                <tr>
                    <td><span class="badge bg-secondary text-light">{{ item.id_producto }}</span></td>
                    <td class="fw-bold">{{ item.nombre }}</td>
                    <td>
                        {% if item.codigo_barras %}
                            <span class="font-monospace text-muted"><i class='bx bx-barcode'></i> {{ item.codigo_barras }}</span>
                        {% else %}
                            <span class="text-muted small">-</span>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        <span class="badge bg-primary fs-6">{{ item.total_cantidad }}</span>
                    </td>
                    <td class="text-center">
                        <fluent-button onclick="window.location.href='{% url 'detalle_inventario' item.id_producto %}{% if sucursal_seleccionada %}?sucursal_id={{ sucursal_seleccionada }}{% endif %}'">
                            <i class='bx bx-show me-1'></i> Ver Detalles
                        </fluent-button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center py-5 text-muted">
                        <div class="mb-3">
                            <i class='bx bx-box fs-1 text-secondary opacity-50'></i>
                        </div>
                        <h5 class="fw-normal">No hay stock registrado</h5>
                        <p class="small mb-0">Prueba ajustando los filtros o asigna stock desde el listado de productos.</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</fluent-card>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const inputBusqueda = document.getElementById('q');
        const selectSucursal = document.getElementById('sucursal_id');
        const selectCategoria = document.getElementById('categoria_id');
        const tableBody = document.getElementById('inventarioBody');
        let timeout = null;

        function updateTable() {
            const url = new URL(window.location);
            
            // Parametro Busqueda
            if (inputBusqueda && inputBusqueda.value) {
                url.searchParams.set('q', inputBusqueda.value);
            } else {
                url.searchParams.delete('q');
            }

            // Parametro Sucursal
            if (selectSucursal && selectSucursal.value) {
                url.searchParams.set('sucursal_id', selectSucursal.value);
            } else {
                url.searchParams.delete('sucursal_id');
            }
            
            // Parametro Categoria
            if (selectCategoria && selectCategoria.value) {
                url.searchParams.set('categoria_id', selectCategoria.value);
            } else {
                url.searchParams.delete('categoria_id');
            }

            // Actualizar URL sin recargar
            window.history.pushState({}, '', url);

            fetch(url)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newBody = doc.getElementById('inventarioBody');
                    if (newBody && tableBody) {
                        tableBody.innerHTML = newBody.innerHTML;
                    }
                })
                .catch(err => console.error('Error actualizando inventario:', err));
        }

     

        // Buscador: de 300ms
        if (inputBusqueda) {
            inputBusqueda.addEventListener('input', () => {
                clearTimeout(timeout);
                timeout = setTimeout(updateTable, 300);
            });
        }

        // Selectores: Cambio inmediato
        if (selectSucursal) {
            selectSucursal.addEventListener('change', updateTable);
            selectSucursal.removeAttribute('onchange'); // Evitar doble submit si estaba inline
        }
        
        if (selectCategoria) {
            selectCategoria.addEventListener('change', updateTable);
            selectCategoria.removeAttribute('onchange');
        }
    });
</script>
{% endblock %}
