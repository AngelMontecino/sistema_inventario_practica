{% extends 'base.html' %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2>Clientes y Proveedores</h2>
    </div>
    <div class="col-md-4 text-end">
        <fluent-button appearance="accent" onclick="window.location.href='{% url 'crear_tercero' %}'">
            <i class='bx bx-user-plus'></i> Nuevo Registro
        </fluent-button>
    </div>
</div>

{% if error %}
<div class="alert alert-danger">{{ error }}</div>
{% endif %}

<!-- Filtros -->
<fluent-card class="mb-4 p-3">
    <form method="get" class="row g-3 align-items-center" id="filterForm" onsubmit="event.preventDefault(); return false;">
        <div class="col-md-5">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0"><i class='bx bx-search text-secondary'></i></span>
                <input type="text" class="form-control border-start-0 ps-0" id="filterBusqueda" name="q" placeholder="Buscar por Nombre o RUT..." value="{{ busqueda }}">
            </div>
        </div>
        <div class="col-md-7 text-end">
            <div class="btn-group" role="group" aria-label="Filtro Roles">
                 <input type="radio" class="btn-check" name="rol" id="rolTodas" value="" autocomplete="off" {% if not filtro_rol %}checked{% endif %}>
                 <label class="btn btn-outline-secondary" for="rolTodas">Todos</label>
               
                 <input type="radio" class="btn-check" name="rol" id="rolCliente" value="cliente" autocomplete="off" {% if filtro_rol == 'cliente' %}checked{% endif %}>
                 <label class="btn btn-outline-primary" for="rolCliente">Clientes</label>
               
                 <input type="radio" class="btn-check" name="rol" id="rolProveedor" value="proveedor" autocomplete="off" {% if filtro_rol == 'proveedor' %}checked{% endif %}>
                 <label class="btn btn-outline-success" for="rolProveedor">Proveedores</label>
            </div>
        </div>
    </form>
</fluent-card>

<!-- Tabla -->
<fluent-card class="p-0 overflow-hidden">
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>RUT/ID</th>
                    <th>Nombre</th>
                    <th>Contacto</th>
                    <th>Roles</th>
                    <th class="text-end">Acciones</th>
                </tr>
            </thead>
            <tbody id="tercerosBody">
                {% for tercero in terceros %}
                <tr>
                    <td>{{ tercero.rut }}</td>
                    <td>{{ tercero.nombre }}</td>
                    <td>
                        {% if tercero.email %}
                        <div><small><i class='bx bx-envelope'></i> {{ tercero.email }}</small></div>
                        {% endif %}
                        {% if tercero.telefono %}
                        <div><small><i class='bx bx-phone'></i> {{ tercero.telefono }}</small></div>
                        {% endif %}
                    </td>
                    <td>
                        {% if tercero.es_cliente %}
                            <span class="badge bg-primary">Cliente</span>
                        {% endif %}
                        {% if tercero.es_proveedor %}
                            <span class="badge bg-success">Proveedor</span>
                        {% endif %}
                    </td>
                    <td class="text-end">
                        {% if request.session.rol != 'VENDEDOR' %}
                        <fluent-button appearance="outline" onclick="window.location.href='{% url 'editar_tercero' tercero.id_tercero %}'">
                            Editar
                        </fluent-button>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center text-muted p-4">
                        No se encontraron registros.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</fluent-card>

<!-- Paginación -->
<div id="paginationContainer" class="d-flex flex-column flex-md-row justify-content-between align-items-center mt-4 bg-light p-3 rounded-3 shadow-sm">
    <div class="text-muted small mb-2 mb-md-0 d-flex align-items-center gap-2">
        <span>Mostrando {{ terceros|length }} de <b>{{ total_items }}</b> registros</span>
        <span class="text-secondary">|</span>
        <span>Página <b>{{ page }}</b> de <b>{{ total_pages }}</b></span>
    </div>
    
    <div class="d-flex align-items-center gap-3">
        <!-- Navegación -->
        <div class="d-flex gap-2">
            <fluent-button appearance="outline" 
                           onclick="changePage(1)"
                           {% if page == 1 %}disabled{% endif %}
                           title="Primera Página">
                <i class='bx bx-chevrons-left'></i>
            </fluent-button>
            <fluent-button appearance="outline" 
                           onclick="changePage({{ page|add:'-1' }})"
                           {% if not has_prev %}disabled{% endif %}
                           title="Anterior">
                <i class='bx bx-chevron-left'></i>
            </fluent-button>
            
            <!-- Ir a página -->
            <div class="d-flex align-items-center ms-2 me-2">
               <span class="me-2 text-muted small">Ir a:</span>
               <input type="number" class="form-control form-control-sm text-center" 
                      style="width: 60px;" 
                      value="{{ page }}" 
                      min="1" 
                      max="{{ total_pages }}"
                      onchange="if(this.value >= 1 && this.value <= {{ total_pages }}) changePage(this.value)">
            </div>

            <fluent-button appearance="outline" 
                           onclick="changePage({{ page|add:'1' }})"
                           {% if not has_next %}disabled{% endif %}
                           title="Siguiente">
                <i class='bx bx-chevron-right'></i>
            </fluent-button>
            <fluent-button appearance="outline" 
                           onclick="changePage({{ total_pages }})"
                           {% if page == total_pages %}disabled{% endif %}
                           title="Última Página">
                <i class='bx bx-chevrons-right'></i>
            </fluent-button>
        </div>
    </div>
</div>

<script>
    function changePage(newPage) {
        const url = new URL(window.location);
        url.searchParams.set('page', newPage);
        window.location.href = url.toString();
    }
</script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const inputBusqueda = document.getElementById("filterBusqueda");
        const radiosRol = document.querySelectorAll('input[name="rol"]');
        const tableBody = document.getElementById("tercerosBody");
        const paginationContainer = document.getElementById("paginationContainer");
        let timeout = null;

        function updateTable() {
            const url = new URL(window.location);
            
            // Al filtrar, resetear a página 1
            url.searchParams.set('page', 1);

            // Parametro Busqueda
            if (inputBusqueda.value) {
                url.searchParams.set("q", inputBusqueda.value);
            } else {
                url.searchParams.delete("q");
            }

            // Parametro Rol 
            let rolValue = "";
            radiosRol.forEach(r => {
                if (r.checked) rolValue = r.value;
            });
            if (rolValue) {
                url.searchParams.set("rol", rolValue);
            } else {
                url.searchParams.delete("rol");
            }

        
            window.history.pushState({}, "", url);
            
        
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, "text/html");
                    
                    const newBody = doc.getElementById("tercerosBody");
                    if (newBody && tableBody) {
                        tableBody.innerHTML = newBody.innerHTML;
                    }

                    // Actualizar Paginación
                    const newPagination = doc.getElementById('paginationContainer');
                    if (newPagination && paginationContainer) {
                        paginationContainer.innerHTML = newPagination.innerHTML;
                    }
                })
                .catch(err => console.error("Error filtrando terceros:", err));
        }

      
        if (inputBusqueda) {
            inputBusqueda.addEventListener("input", function() {
                clearTimeout(timeout);
                timeout = setTimeout(updateTable, 300);
            });
        }

        radiosRol.forEach(radio => {
            radio.addEventListener("change", updateTable);
        });
    });
</script>
{% endblock %}
